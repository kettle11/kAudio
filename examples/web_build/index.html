<html>

<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
</head>

<body style="margin:0; overflow-y: hidden;overflow-x: hidden;">
  <noscript>This page requires WebAssembly and Javascript to be enabled.</noscript>
  <canvas id='canvas' style="width:100vw; height: 100vh;" oncontextmenu="return false;"></canvas>
  <script>

    console.log("HELLO THERE");
    var wasm_memory;
    var wasm_module;
    var audio_running = false;

    // The 'wbg' name is used here to imitate WasmBindgen.
    // I'm not sure if this will matter in any way.
    var imports = {
      env: {},
    };

    console.log("HI");
    wasm_memory = imports.env.memory = new WebAssembly.Memory({ initial: 31, maximum: 16384, shared: true });

    fetch('sine.wasm').then(response =>
      response.arrayBuffer()
    ).then(bytes =>
      WebAssembly.instantiate(bytes, imports)
    ).then(results => {
      wasm_module = results.module;
      // Call our start function.
      results.instance.exports.main();


      document.onpointerdown = (event) => {
        if (!audio_running) {
          setup_worklet();
          audio_running = true;
        }
      };
    });

    async function setup_worklet() {
      const audioContext = new AudioContext({ sampleRate: 44100 });
      await audioContext.audioWorklet.addModule('audio_worklet.js');
      const worklet = new AudioWorkletNode(audioContext, 'kaudio-processor');
      worklet.connect(audioContext.destination);
      let message = {}
      message.wasm_memory = wasm_memory;
      message.wasm_module = wasm_module;

      worklet.port.postMessage(message);
    }

  </script>
</body>

</html>